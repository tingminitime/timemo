---
id: javascript-virtual-dom
title: JavaScript - Virtual DOM
sidebar_label: Virtual DOM - æ¡†æ¶åŸºç¤æ¢ç´¢
sidebar_position: 5
tags: [JavaScript, Virtual DOM, ä¸‹ç­å¾Œçš„ç¨‹å¼è®€æ›¸æœƒ]
---

# Virtual DOM | æ¡†æ¶åŸºç¤æ¢ç´¢

> æ­¤ç­†è¨˜éåŸå‰µï¼Œå¤§éƒ¨åˆ†å…§å®¹åƒè€ƒ Leo Chiu æ–‡ç«  [Virtual DOM | ç‚ºäº†ç­è§£åŸç†ï¼Œé‚£å°±ä¾†å¯¦ä½œä¸€å€‹ç°¡æ˜“ Virtual DOM å§ï¼](https://medium.com/%E6%89%8B%E5%AF%AB%E7%AD%86%E8%A8%98/build-a-simple-virtual-dom-5cf12ccf379f) æ’°å¯«ã€‚

> æ­¤ç­†è¨˜æ–¼ 2022/01/05 æ’°å¯«ã€‚

## ç‚ºä»€éº¼è¦ç†è§£ Virtual DOM ?

1. æ“ä½œ Virtual DOM åŠç›´æ¥å° DOM æ“ä½œçš„å„ªç¼ºé»ã€‚
2. æ›´äº†è§£ Vueã€React ç­‰æ¡†æ¶å¦‚ä½•åˆ©ç”¨ Virtual DOM é”åˆ°æ•ˆèƒ½å„ªåŒ–ã€‚
3. æ›´äº†è§£ MVVM æ¶æ§‹ä¸­ ViewModel çš„æ ¸å¿ƒåŸç†ï¼ŒçŸ¥é“è³‡æ–™æ”¹è®Šæ˜¯å¦‚ä½•è§¸ç™¼ç•«é¢æ”¹è®Šçš„ã€‚
4. å¹«åŠ©äº†è§£æ¡†æ¶é€²è¡Œ Virtual DOM æ¯”å°åŸç†ï¼Œåœ¨æ¡†æ¶ä¸­æ’°å¯«ç¨‹å¼æ™‚ï¼Œæ‰‹æ„Ÿæœƒæ›´æ‰å¯¦ã€‚

<br />

## Virtual DOM æ¦‚å¿µ

**Virtual DOM** æ˜¯ä»¥ JavaScript ç‰©ä»¶æ¨¡æ“¬ç‰¹å®š DOM Treeï¼Œä¸ç›´æ¥æ“ä½œçœŸå¯¦ DOMï¼Œè€Œæ˜¯ä½¿ç”¨æ“ä½œæ¨¡æ“¬ DOM Treeï¼Œç­‰å¾…æ“ä½œçµæŸå¾Œï¼Œå†å°‡è®Šæ›´æ›´æ–°å›çœŸå¯¦ DOM ä¸Šï¼Œé”åˆ°æ•ˆèƒ½å„ªåŒ–ç›®çš„ã€‚

![](https://i.imgur.com/IglDq2I.png)
( åœ–ç‰‡ä¾†æº : https://medium.com/æ‰‹å¯«ç­†è¨˜/build-a-simple-virtual-dom-5cf12ccf379f )

:::info
åˆ©ç”¨ Virtual DOM çš„æ“ä½œï¼Œå¯ä»¥é”åˆ°åƒ…æ›´æ–°æœ‰ä¿®æ”¹è®Šå‹•çš„ DOM å„ªåŒ–æ¸²æŸ“æ•ˆèƒ½ï¼Œä¸æœƒæ•´å€‹ DOM Tree éƒ½é‡æ–°æ¸²æŸ“ã€‚
:::

<br />

### JS æ¨¡æ“¬ Virtual DOM ç‰©ä»¶ :

```jsx showLineNumbers
const vNode = {
  tagName: 'div',
  attrs: {
    class: 'container',
    style: 'display: flex;'
  },
  children: [
    tagName: 'a',
    attrs: {
      href: 'https://www.google.com',
      class: 'link',
      style: 'text-decoration: none;'
    },
    children: [...],
  ],
}
```

ä»¥å¾€æˆ‘å€‘ä½¿ç”¨ `innerHTML` ä¾†æ“ä½œæ›´æ–°ç•«é¢ï¼Œå› ç‚ºç°¡å–®æš´åŠ› (?)ã€‚

ä½† `innerHTML` æœ‰å¾ˆå¤šæ½›åœ¨çš„å•é¡Œï¼Œä¾‹å¦‚ :

1. é¸å®šçš„ DOM ä½¿ç”¨ `innerHTML`ï¼ŒDOM çš„æ‰€æœ‰å­å…ƒç´ é€šé€šæœƒé‡æ–°æ¸²æŸ“ä¸€éï¼Œé€ æˆç€è¦½å™¨æ•ˆèƒ½è² æ“”ã€‚
2. `innerHTML` æ½›è— XSS æ”»æ“Šé¢¨éšªã€‚
3. ä¸€ä¸å°å¿ƒé‚„æœƒç”¨è¿´åœˆå¤šæ¬¡æ¸²æŸ“ DOM Treeï¼Œé€ æˆæ²’å¿…è¦çš„æ•ˆèƒ½æµªè²»ã€‚

<br />

## æ‰€ä»¥ä½¿ç”¨ Virtual DOM éƒ½æ²’æœ‰ç¼ºé» ?

ç¨‹å¼é¸æ“‡è­°é¡Œé€šå¸¸æ˜¯ä¸€é«”å…©é¢ï¼Œæœ‰å¥½æœ‰å£ï¼Œé¸æ“‡äº†ä¸€å€‹æ–¹å¼é€šå¸¸æœƒä¼´éš¨å„ªå‹¢å’Œç¼ºé»ã€‚

Virtual DOM æ˜¯ä¾é è¨˜æ†¶é«”ç©ºé–“å­˜æ”¾ç‰©ä»¶ï¼Œå› æ­¤æ“ä½œ Virtual DOM ä¹Ÿæœƒæé«˜ç¶²é è¨˜æ†¶é«”çš„ä½¿ç”¨é‡ï¼Œå¦å¤– Virtual DOM çš„å¯«æ³•é€šå¸¸ä¹Ÿæ¯”è¼ƒè¤‡é›œä¸åƒå–®ç´”æ“ä½œ DOM ä¾†çš„æ–¹ä¾¿ç›´è¦ºã€‚

<br />

## æ“ä½œ DOM çš„æ–¹å¼

### 1. `document.createElement(tagName)`

å¯ä»¥ç”¢ç”ŸæŒ‡å®šæ¨™ç±¤åç¨±çš„ HTML å…ƒç´ ã€‚

```jsx showLineNumbers
let div = document.createElement('div') // <div></div>
```

<br />

### 2. `document.createTextNode(textContent)`

ç”¢ç”Ÿä¸€å€‹æ–‡å­—ç¯€é»

```jsx showLineNumbers
let text = document.createTextNode('Hello world !!') // #text
console.log(text.textContent) // Hello world !!
```

<br />

### 3. `ParentNode.appendChild(childNode)`

å°‡ä¸€å€‹**ç¯€é»**é™„åŠ åˆ°æŒ‡å®šçˆ¶ç¯€é» ( ParentNode ) çš„å­ç¯€é»åˆ—è¡¨æœ«å°¾è™•ï¼Œå¦‚æœå°‡è¢«é™„åŠ çš„ç¯€é»å·²å­˜åœ¨ DOM Tree ä¸­ï¼Œ`appendChild()` åªæœƒå°‡è©²ç¯€é»ç§»å‹•è‡³æ–°çš„ä½ç½®ï¼Œä¸éœ€äº‹å…ˆç§»é™¤ã€‚

```jsx showLineNumbers
const app = document.querySelector('div#app')
let p = document.createElement('p')
app.appendChild(p)
```

æ­¤æ™‚çš„ HTML :

```html showLineNumbers
<div id="app">
  <p></p>
</div>
```

<br />

### 4. `el.setAttrribute(name, value)`

è¨­ç½® `el` ä¸ŠæŸå€‹å±¬æ€§å€¼ï¼Œå¦‚æœå±¬æ€§å·²ç¶“å­˜åœ¨ï¼Œå‰‡æ›´æ–°è©²å€¼ï¼›å¦å‰‡æ·»åŠ æ–°çš„å±¬æ€§åç¨±èˆ‡å€¼ã€‚

```jsx showLineNumbers
let img = document.querySelector('.img') // <img class="img">
img.setAttribute('src', './img.png') // <img class="img" src="./img.png">
img.setAttribute('alt', 'Image') // <img class="img" src="./img.png" alt="Image">
```

<br />

### 5. `el.removeAttribute(name)`

å°‡ `el` ä¸ŠæŸå€‹å±¬æ€§ç§»é™¤ã€‚

```jsx
img.removeAttribute('alt') // <img class="img" src="./img.png">
```

<br />

### 6. `ChildNode.replaceWith(target)`

å°‡ `target` ( Node ç‰©ä»¶ æˆ– DOMString ) æ›¿æ›è©²ç¯€é» ( ChildNode ) çš„çˆ¶ç¯€é»ä¸‹ç•¶å‰çš„å­ç¯€é»ã€‚

```jsx showLineNumbers
const app = document.querySelector('div#app')
let p = document.createElement('p')
app.appendChild(p)

let span = document.createElement('span')
p.replaceWith(span)
```

æ­¤æ™‚çš„ HTML :

```html showLineNumbers
<div id="app">
  <span></span>
</div>
```

<br />

### 7. `el.remove()`

å°‡ `el` å¾å®ƒæ‰€å±¬çš„ DOM Tree ä¸­åˆªé™¤ã€‚

```jsx showLineNumbers
let el = document.querySelector('p.text')
el.remove()
```

<br />

### å…¶ä»– DOM æ“ä½œ

#### 1. `document.createDocumentFragment()`

å±¬æ–¼ DOM çš„ç¯€é» ( Node )ï¼Œå¯¦éš›æ¸²æŸ“åˆ° DOM ä¸Šæœƒå°‡ fragment è£¡é¢æ‰€æœ‰å­ç¯€é»æ¸²æŸ“å‡ºä¾†ï¼Œè€Œ fragment æœ¬èº«æœƒè¢«é€™äº›å­ç¯€é»å–ä»£ï¼Œå¯ä»¥æŠŠ fragment ç•¶ä½œæ˜¯è£é€™äº›å­ç¯€é»çš„ç®±å­ï¼Œç®±å­åªæ˜¯ä¸€å€‹åŒ…è£è€Œå·²ã€‚

[MDN é€£çµ](https://developer.mozilla.org/zh-TW/docs/Web/API/Document/createDocumentFragment)

#### 2. `Node.cloneNode()`

ç”¨ä¾†è¤‡è£½ä¸€å€‹ç¯€é» ( Node )ã€‚

[MDN é€£çµ](https://developer.mozilla.org/zh-TW/docs/Web/API/Node/cloneNode)

#### ç¯„ä¾‹ :

```jsx showLineNumbers
// é ç¢¼åŠŸèƒ½ - å»ºç«‹ HTML æ¨¡æ¿ ( å‚³é™£åˆ—è³‡æ–™ )
function createHTML(elData) {
  let fragment = document.createDocumentFragment()
  let el_li = document.createElement('li')
  let el_a = document.createElement('a')
  elData.forEach(el => {
    el_li = el_li.cloneNode(false)
    el_a = el_a.cloneNode(false)
    el_li.setAttribute('class', 'filterPage__pagination-item flex-center')
    el_a.setAttribute('href', 'javascript:;')
    el_a.setAttribute('class', el['className'])
    el_a.setAttribute('data-page', el['content'])
    el_a.innerHTML = el['content']
    el_li.appendChild(el_a)
    fragment.appendChild(el_li)
  })
  return fragment // <li><a>...</a></li>
}
```

<br />

## Virtual DOM åŸç†

![](https://i.imgur.com/r25zqAl.png) <br />
( åœ–ç‰‡ä¾†æº : https://medium.com/æ‰‹å¯«ç­†è¨˜/build-a-simple-virtual-dom-5cf12ccf379f )

### 1. å»ºç«‹æè¿° DOM çš„ç‰©ä»¶ - vNode - `vNode.js`ã€`createElement.js`

```jsx showLineNumbers
const vNode = {
  tagName: 'div',
  attrs: {
    id: 'app',
    class: 'container',
  },
  children: [
    //...
  ],
}
```

ä¸Šé¢æ˜¯éå¸¸ç°¡æ˜“æè¿° DOM çš„ç‰©ä»¶ï¼Œé€é `tagName` å®šç¾© HTML æ¨™ç±¤åç¨±ï¼Œ`attrs` ç‚ºåŒ…å« HTML æ¨™ç±¤ä¸Šæ‰€æœ‰å±¬æ€§çš„ç‰©ä»¶ï¼Œ`children` ç‚ºè©² HTML å…ƒç´ åº•ä¸‹æ‰€æœ‰å­å…ƒç´ ã€‚

<br />

### 2. å°‡ vNode è½‰æ›æˆå¯¦éš›çš„ Node - `render.js`

ä¹Ÿå°±æ˜¯å°‡æè¿° DOM çš„ç‰©ä»¶ ( å¦‚ä¸Š )ï¼Œè½‰æ›æˆé€™æ¨£çš„éç¨‹ :

```html
<div
  id="app"
  class="container"
>
  <!-- children... -->
</div>
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€™é‚Šåªæ˜¯å€‹éç¨‹ï¼Œç•«é¢æ­¤æ™‚é‚„ä¸¦æ²’æœ‰è½‰æ›å¾Œçš„çµæœï¼Œæœ€å¾Œé ˆå›å‚³çµæœï¼Œäº¤ç”±å…¶ä»–ç¨‹å¼è™•ç†ã€‚

<br />

### 3. æŠŠ Node æ›è¼‰åˆ°çœŸå¯¦ DOM ä¸Š - `mount.js`

é¡§åæ€ç¾©ï¼Œå°‡ vNode è½‰æ›å¾Œå›å‚³çš„çµæœæ›è¼‰åˆ°ç•«é¢ä¸Šå‘ˆç¾ ( `replaceWith()` )

<br />

## Virtual DOM é‹ä½œéç¨‹

Vue ä»¥è³‡æ–™é©…å‹•åšåŸºç¤ï¼Œç•¶è³‡æ–™ç™¼ç”Ÿæ”¹è®Šï¼Œç•«é¢ä¸Šæœ‰é€£å‹•åˆ°è³‡æ–™çš„ DOM ä¹Ÿæœƒè·Ÿè‘—æ”¹è®Šã€‚

é€é diff ( `diff.js` ) æ¼”ç®—æ³•æ¯”è¼ƒ **æ–°çš„ Virtual DOM** å’Œ **èˆŠçš„ Virtual DOM**ï¼Œå†æ”¹è®ŠçœŸå¯¦ DOMï¼Œé€™é‚Šæˆ‘å€‘æœ‰å…©ç¨®æ–¹å¼åšè³‡æ–™çš„æ›´æ–° :

### 1. å®šæ™‚å™¨ Timer æ¯ç§’åŸ·è¡Œæ¼”ç®—æ³•æ¯”è¼ƒ : `setInterval(..., 1000)`

![vDOM_process.png](https://i.imgur.com/lcnzBy5.png) <br />
( åœ–ç‰‡ä¾†æº : https://medium.com/æ‰‹å¯«ç­†è¨˜/build-a-simple-virtual-dom-5cf12ccf379f )

### 2. è§€å¯Ÿè€…æ¨¡å¼ Observer Pattern : `Proxy`

![vDOM_proxy.png](https://i.imgur.com/4HUJurf.png) <br />
( åœ–ç‰‡ä¾†æº : https://medium.com/æ‰‹å¯«ç­†è¨˜/build-a-simple-virtual-dom-5cf12ccf379f )

<br />

## é–‹å§‹å¯¦ä½œ

**ğŸ’¡ æƒ…å¢ƒï¼šä½¿ç”¨ Virtual DOM æ¯ç§’éš¨æ©Ÿç”¢ç”Ÿ 0 ~ 9 å¼µæŒ‡å®šçš„åœ–ç‰‡ã€‚**

### ä¸»ç¨‹å¼ - vNode.js

å°‡ä¸Šé¢ Virtual DOM åŸç†æ‰€éœ€è¦ç”¨åˆ°çš„åŠŸèƒ½åŒ¯å…¥ä¸»ç¨‹å¼ :

```jsx showLineNumbers
import createElement from './createElement.js'
import render from './render.js'
import mount from './mount.js'
import diff from './diff.js'
```

å…ˆä»‹ç´¹ä¸»ç¨‹å¼éƒ¨åˆ†ï¼Œç¨å¾Œæœƒä¾†çœ‹çœ‹é€™äº›åŠŸèƒ½éƒ½æ˜¯å¦‚ä½•ä½¿ç”¨ JS é”æˆçš„ã€‚

å»ºç«‹ä¸€å€‹æœƒ **å›å‚³æè¿° DOM ç‰©ä»¶** çš„å‡½å¼ `createVApp()`ï¼Œé€™å€‹å‡½å¼éœ€è¦å‚³å…¥éš¨æ©Ÿ 0 ~ 10 çš„ `count`

```jsx showLineNumbers
const createVApp = function (count) {
  // ç”¢ç”Ÿæœ€å¤–å±¤ id="app" çš„ div å®¹å™¨ï¼Œæ‰€æœ‰æ›´å‹•éƒ½æœƒæ›è¼‰åˆ°é€™å€‹ app å®¹å™¨ä¸Š
  return createElement('div', {
    attrs: {
      id: 'app',
      'data-count': count,
    },
    children: [
      // ç”¢ç”Ÿä¸€å€‹å®¹å™¨ div
      createElement('div', {
        attrs: {
          class: 'container',
          style: 'display: flex; flex-direction: column; align-items: center;',
        },
        children: [
          // ç”¢ç”Ÿä¸€å€‹æ”¾æ–‡å­—çš„ div å®¹å™¨
          createElement('div', {
            attrs: {
              style: 'padding: 12px 0; font-size: 20px;',
            },
            children: [
              // ç”¢ç”Ÿä¸€å€‹æè¿°åœ–ç‰‡æ•¸é‡çš„æ–‡å­—
              String(`Current count: ${count}`),
            ],
          }),
          // ç”¢ç”Ÿä¸€å€‹åœ–ç‰‡ div å®¹å™¨
          createElement('div', {
            attrs: {
              class: 'imgContainer',
            },
            children: [
              // ç”¢ç”Ÿ count æ•¸é‡çš„ img DOM ç‰©ä»¶
              ...Array.from({ length: count }, () =>
                createElement('img', {
                  attrs: {
                    src: './cat.jpg',
                    alt: 'cat meme',
                    style: 'width: 100px; margin: 4px 4px;',
                  },
                })
              ),
            ],
          }),
        ],
      }),
    ],
  })
}
```

<br />

åˆå§‹åŒ– **Virtual DOM â†’ Real DOM**

```jsx showLineNumbers
let count = 0 // é è¨­ count æ•¸é‡
let vApp = createVApp(count) // å»ºç«‹æè¿° DOM ç‰©ä»¶
const $app = render(vApp) // å°‡ DOM ç‰©ä»¶è½‰æ›æˆå¯¦éš›çš„ Node
let $rootEl = mount($app, document.getElementById('app')) // å°‡å¯¦éš› Node æ›è¼‰åˆ°ç•«é¢ä¸Š
```

<br />

ä½¿ç”¨ `setInterval` ç•¶è¨ˆæ™‚å™¨ï¼Œæ¯ç§’æ›´æ–° `count` éš¨æ©Ÿæ•¸ï¼Œä¸¦å‘¼å« `createVApp(count)` è³¦å€¼åˆ°æ–°è®Šæ•¸ä¸Š `vNewApp`ï¼Œä¸¦ä½¿ç”¨ diff åŠé€é diff å›å‚³çš„ patch å‡½å¼æ›´æ–° Nodeã€‚

```jsx showLineNumbers
setInterval(() => {
  count = Math.floor(Math.random() * 10) // æ¯ç§’éš¨æ©Ÿ 0 ~ 10 æ•¸å­—
  const vNewApp = createVApp(count) // æ–°çš„æè¿° DOM ç‰©ä»¶
  const patch = diff(vApp, vNewApp) // diff å›å‚³çš„å‡½å¼ç”¨è®Šæ•¸ patch æ¥ä½
  $rootEl = patch($rootEl) // ä½¿ç”¨ patch å‡½å¼æ›´æ–° Node
  // console.log($rootEl) // $rootEl ç‚ºå¯¦éš› Nodeï¼Œæ˜¯å¯ä»¥ç›´æ¥æ“ä½œçš„
  vApp = vNewApp // æ›´æ–°æè¿° DOM ç‰©ä»¶
}, 1000)
```

#### ä¸»ç¨‹å¼å®Œæ•´ç¨‹å¼ç¢¼

```jsx showLineNumbers
// ----- vNode.js -----
import createElement from './createElement.js'
import render from './render.js'
import mount from './mount.js'
import diff from './diff.js'

const createVApp = function (count) {
  // ç”¢ç”Ÿæœ€å¤–å±¤ id="app" çš„ div å®¹å™¨ï¼Œæ‰€æœ‰æ›´å‹•éƒ½æœƒæ›è¼‰åˆ°é€™å€‹ app å®¹å™¨ä¸Š
  return createElement('div', {
    attrs: {
      id: 'app',
      'data-count': count,
    },
    children: [
      // ç”¢ç”Ÿä¸€å€‹å®¹å™¨ div
      createElement('div', {
        attrs: {
          class: 'container',
          style: 'display: flex; flex-direction: column; align-items: center;',
        },
        children: [
          // ç”¢ç”Ÿä¸€å€‹æ”¾æ–‡å­—çš„ div å®¹å™¨
          createElement('div', {
            attrs: {
              style: 'padding: 12px 0; font-size: 20px;',
            },
            children: [
              // ç”¢ç”Ÿä¸€å€‹æè¿°åœ–ç‰‡æ•¸é‡çš„æ–‡å­—
              String(`Current count: ${count}`),
            ],
          }),
          // ç”¢ç”Ÿä¸€å€‹åœ–ç‰‡ div å®¹å™¨
          createElement('div', {
            attrs: {
              class: 'imgContainer',
            },
            children: [
              // ç”¢ç”Ÿ count æ•¸é‡çš„ img DOM ç‰©ä»¶
              ...Array.from({ length: count }, () =>
                createElement('img', {
                  attrs: {
                    src: './cat.jpg',
                    alt: 'cat meme',
                    style: 'width: 100px; margin: 4px 4px;',
                  },
                })
              ),
            ],
          }),
        ],
      }),
    ],
  })
}

let count = 0 // é è¨­ count æ•¸é‡
let vApp = createVApp(count) // å»ºç«‹æè¿° DOM ç‰©ä»¶
const $app = render(vApp) // å°‡ DOM ç‰©ä»¶è½‰æ›æˆå¯¦éš›çš„ Node
let $rootEl = mount($app, document.getElementById('app')) // å°‡å¯¦éš› Node æ›è¼‰åˆ°ç•«é¢ä¸Š

setInterval(() => {
  count = Math.floor(Math.random() * 10) // æ¯ç§’éš¨æ©Ÿ 0 ~ 10 æ•¸å­—
  const vNewApp = createVApp(count) // æ–°çš„æè¿° DOM ç‰©ä»¶
  const patch = diff(vApp, vNewApp) // diff å›å‚³çš„å‡½å¼ç”¨è®Šæ•¸ patch æ¥ä½
  $rootEl = patch($rootEl) // ä½¿ç”¨ patch å‡½å¼æ›´æ–° Node
  // console.log($rootEl) // $rootEl ç‚ºå¯¦éš› Nodeï¼Œæ˜¯å¯ä»¥ç›´æ¥æ“ä½œçš„
  vApp = vNewApp // æ›´æ–°æè¿° DOM ç‰©ä»¶
}, 1000)
```

<br />

### å»ºç«‹æè¿° DOM ç‰©ä»¶ - createElement.js

åœ¨ä¸»ç¨‹å¼ vNode.js æœ‰å¤šæ¬¡å‘¼å« `createElement()`ï¼Œé€éå‚³å…¥åƒæ•¸å»ºç«‹æè¿° DOM ç‰©ä»¶ã€‚

```jsx showLineNumbers
const createElement = function (tagName, { attrs = {}, children = [] } = {}) {
  return {
    tagName,
    attrs,
    children,
  }
}

export default createElement
```

æ¯”è¼ƒè¦æ³¨æ„çš„æ˜¯ï¼ŒHTML æ¨™ç±¤å±¬æ€§ `attrs` æ˜¯ç‰©ä»¶ï¼Œè€Œ HTML æ¨™ç±¤å¦‚æœé‚„æœ‰å­å…ƒç´ ï¼Œæ˜¯å‚³å…¥ `children` é™£åˆ—è£¡é¢ï¼Œæ–¹ä¾¿æˆ‘å€‘å¾ŒçºŒä½¿ç”¨è¿´åœˆæˆ–éè¿´æ“ä½œï¼Œå¦å¤–ä¹Ÿè¦åœ¨åƒæ•¸ä¸Šçµ¦äºˆé è¨­å€¼ ( ç©ºç‰©ä»¶ã€ç©ºé™£åˆ— )ã€‚

<br />

### å°‡ vNode è½‰æ›æˆå¯¦éš›çš„ Node - render.js

ä¸»è¦å°±æ˜¯è² è²¬æŠŠ `createElement()` ç”¢ç”Ÿçš„ DOM ç‰©ä»¶è½‰æ›æˆå¯¦éš›çš„ Nodeã€‚

```jsx showLineNumbers
const render = function (vNode) {
  // console.log(vNode)
  if (typeof vNode === 'string') {
    return document.createTextNode(vNode)
  }
  return renderElement(vNode)
}

// ä¸æ˜¯å–®ç´”å­—ä¸²
const renderElement = function ({ tagName, attrs, children }) {
  const $el = document.createElement(tagName)
  // HTML æ¨™ç±¤å±¬æ€§è¨­å®š
  for (const key in attrs) {
    $el.setAttribute(key, attrs[key])
  }
  // HTML æ¨™ç±¤çš„å­å…ƒç´ éè¿´è¨­å®š
  children.forEach(child => {
    const $child = render(child)
    $el.appendChild($child)
  })
  // console.log('e.target: ', $el)
  return $el
}

export default render
```

æ’°å¯« HTML æ¨™ç±¤çš„æ™‚å€™ï¼Œå­å…ƒç´ ä¸åªæœ‰ tagï¼Œä¹Ÿæœ‰å­—ä¸² Stringï¼Œå› æ­¤æˆ‘å€‘è¦åœ¨è½‰æ›æˆçœŸå¯¦ Node çš„æ™‚å€™ï¼ŒæŠŠé‡åˆ°å­—ä¸²çš„ç‹€æ³è€ƒé‡é€²å»ã€‚

åœ¨ `render(vNode)` é€™å€‹ function ä¸­ï¼Œå¦‚æœ `vNode` å‚³å…¥çš„ç¯€é»æ˜¯å­—ä¸²ï¼Œå°±å›å‚³ `document.createTextNode(vNode)` é€™å€‹æ–¹æ³•ï¼›å¦‚æœä¸æ˜¯å­—ä¸²ï¼Œå°±å›å‚³ `renderElement(vNode)` é€™å€‹ functionã€‚

åœ¨ `renderElement(vNode)` é€™å€‹ function ä¸­ï¼Œå› ç‚ºå¯ä»¥ç¢ºå®šæ˜¯å‚³å…¥ DOM æè¿°ç‰©ä»¶è€Œéå­—ä¸²ï¼Œæ‰€ä»¥æˆ‘å€‘ä½¿ç”¨å‚³å…¥çš„ `tagName` ç”¢ç”Ÿæ–°ç¯€é»ï¼Œé€é `for in` å’Œ `setAttribute()` è¨­å®šå±¬æ€§ï¼Œä¸”å› ç‚ºæˆ‘å€‘å­å…ƒç´ å„²å­˜åœ¨ `children` é™£åˆ—ï¼Œä½¿ç”¨éè¿´å‘¼å« `render()` çš„æ–¹å¼è¨ªå•æ‰€æœ‰å­å…ƒç´ çš„å­å…ƒç´ ï¼Œå’Œ `appendChild()` å°‡æ‰€æœ‰å­å…ƒç´ æ›åˆ°ç•¶å‰ç¯€é» ( `tagName`ï¼Œä¹Ÿå°±æ˜¯ `$el` ) ä¸Šï¼Œä¸¦å›å‚³ï¼Œæ­¤æ™‚çš„ `$el` å·²ç¶“æˆåŠŸè½‰æ›æˆå¯¦éš›çš„ Nodeï¼Œæ¥ä¸‹ä¾†åªè¦æŠŠé€™å€‹ Node æ›è¼‰åˆ°ç•«é¢ä¸Šå°±å¥½äº†ã€‚

<br />

### æŠŠ Node æ›è¼‰åˆ°çœŸå¯¦ DOM ä¸Š - mount.js

åŠŸèƒ½éå¸¸å–®ç´”ï¼Œä½¿ç”¨å‰é¢ä»‹ç´¹çš„ `replaceWith()` åŠŸèƒ½æ›¿æ›æˆæ–°çš„ DOM Treeã€‚

```jsx showLineNumbers
export default function ($node, $target) {
  // highlight-next-line
  $target.replaceWith($node)
  return $node
}
```

åœ¨ä¸»ç¨‹å¼åˆå§‹åŒ–ï¼Œæˆ‘å€‘ä½¿ç”¨ :

```jsx showLineNumbers
let $rootEl = mount($app, document.getElementById('app'))
```

æŠŠç”¢ç”Ÿçš„ `$app` é€™å€‹ DOM Treeï¼Œæ›è¼‰ ( æ›¿æ› ) åˆ° `<div id=â€appâ€></div>` ä¸Šã€‚

<br />

### Diff æ¼”ç®—æ³•

è¦æŠŠä¸€æ£µæ¨¹ ( DOM Tree )è½‰æ›æˆå¦ä¸€æ£µæ¨¹ï¼Œä¸¦ä¸”è¦ä½¿ç”¨æœ€å°‘çš„æ­¥é©Ÿï¼Œå…¶æ™‚é–“è¤‡é›œåº¦æ˜¯ O(nÂ³)ã€‚å•é¡Œåœ¨æ–¼å¦‚æœç¯€é»æœ‰ 1000 å€‹ï¼Œæ‰€ä»¥è¨ˆç®—é‡å°±ä¾†åˆ° 10 å„„æ¬¡ï¼Œè¨ˆç®—é‡å°‡æœƒè®“ CPU é€ æˆä¸å°çš„é–‹éŠ·ã€‚

å› æ­¤ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼ŒReact èˆ‡ Vue å°‡æ™‚é–“è¤‡é›œåº¦é™ä½è‡³ **O(n)**ï¼Œç¸½æ­¸ä¾†èªªï¼Œå°±æ˜¯åªè™•ç†åŒä¸€å±¤ç´šçš„ç¯€é»ï¼Œä¸é€²è¡Œè·¨ç¯€é»çš„æ¯”è¼ƒï¼Œå¦‚æœé‡åˆ°ç¯€é»ä¸ä¸€æ¨£çš„æƒ…æ³ï¼Œå°±ç æ‰é‡æ–°å»ºç«‹ç¯€é»ã€‚

è€Œæ­¤ç¯‡æ–‡ç« ä½¿ç”¨çš„ Diff ç®—æ³•çš„æ™‚é–“è¤‡é›œåº¦ä¹Ÿæ˜¯ **O(n)**ï¼Œåªè™•ç†åŒä¸€å±¤ç´šçš„ç¯€é»ã€‚

> ä»¥ä¸Šæˆªè‡³ : [Virtual DOM | ç‚ºäº†ç­è§£åŸç†ï¼Œé‚£å°±ä¾†å¯¦ä½œä¸€å€‹ç°¡æ˜“ Virtual DOM å§ï¼](https://medium.com/%E6%89%8B%E5%AF%AB%E7%AD%86%E8%A8%98/build-a-simple-virtual-dom-5cf12ccf379f#e645)

<br />

**O(1) é™£åˆ—è®€å–**

ç›´æ¥è®€å–é™£åˆ—ä¸­æŸå€‹ä½ç½®çš„å€¼ï¼Œå…±èŠ±è²» 1 å€‹æ­¥é©Ÿã€‚

```jsx showLineNumbers
const ary = [1, 2, 3, 4, 5]
console.log(ary[2]) // 3
```

<br />

**O(n) ç°¡æ˜“æœå°‹**

å¾ index: 0 é–‹å§‹æœå°‹åˆ° n å€‹ä½ç½®ç›´åˆ°ç²å–ç›®æ¨™ ( å…±èŠ± n å€‹æ­¥é©Ÿ )ã€‚

```jsx showLineNumbers
const ary = [1, 2, 3, 4, 5]
ary.forEach(item => {
  if (item === 3) console.log(item) // 3
})
```

<br />

**O(log n) äºŒåˆ†æœå°‹æ³•**

çµ‚æ¥µå¯†ç¢¼æ¦‚å¿µï¼Œä¹Ÿå¯ä»¥åƒè€ƒæ­¤ Codepen :

<iframe
  height="300"
  style="width: 100%;"
  style={{
    width: '100%',
  }}
  scrolling="no"
  title="BigOlogn"
  src="https://codepen.io/jake1155/embed/Yzebweg?default-tab=js"
  frameborder="no"
  loading="lazy"
  allowtransparency="true"
  allowfullscreen="true"
>
  See the Pen <a href="https://codepen.io/jake1155/pen/Yzebweg">BigOlogn</a> by
  Ting Lin (<a href="https://codepen.io/jake1155">@jake1155</a>) on{' '}
  <a href="https://codepen.io">CodePen</a>.
</iframe>

<br />

- æ™‚é–“è¤‡é›œåº¦åƒè€ƒæ–‡ç«  : [åˆå­¸è€…å­¸æ¼”ç®—æ³•ï½œå¾æ™‚é–“è¤‡é›œåº¦èªè­˜å¸¸è¦‹æ¼”ç®—æ³•](https://medium.com/appworks-school/%E5%88%9D%E5%AD%B8%E8%80%85%E5%AD%B8%E6%BC%94%E7%AE%97%E6%B3%95-%E5%BE%9E%E6%99%82%E9%96%93%E8%A4%87%E9%9B%9C%E5%BA%A6%E8%AA%8D%E8%AD%98%E5%B8%B8%E8%A6%8B%E6%BC%94%E7%AE%97%E6%B3%95-%E4%B8%80-b46fece65ba5)

<br />

Diff æ¼”ç®—æ³•ä¸»è¦å‚³å…¥å…©å€‹åƒæ•¸ï¼Œåˆ†åˆ¥æ˜¯ `vOldNode` èˆŠçš„ DOM ç‰©ä»¶ï¼Œå’Œ `vNewNode` æ–°çš„ DOM ç‰©ä»¶ï¼Œé€™å…©å€‹åƒæ•¸éƒ½æ˜¯æè¿° DOM çš„ç‰©ä»¶ã€‚

å‡½å¼éœ€è¦è€ƒæ…®å››ç¨®æƒ…æ³ :

1. å¦‚æœ `vNewNode` ç‚º `undefined`ï¼Œä»£è¡¨åŸå…ˆçš„ `vOldNode` é€™å€‹ç¯€é»æ˜¯å³å°‡è¦è¢«åˆªé™¤çš„ç¯€é»ï¼Œæ‰€ä»¥è¦ä½¿ç”¨ `remove()` çš„æ–¹å¼ç§»é™¤å¯¦éš› Node ç¯€é»ã€‚
2. èˆŠç¯€é» æˆ– æ–°ç¯€é»å¯èƒ½æœƒæ˜¯å­—ä¸²ï¼Œå¦‚æœå…©è€…ä¸ä¸€æ¨£ï¼Œå‰‡æ–°ç¯€é»æ–‡å­—å–ä»£èˆŠç¯€é»æ–‡å­—ï¼Œåä¹‹å‰‡ä¸è®Šã€‚
3. èˆŠç¯€é» èˆ‡ æ–°ç¯€é»æ¨™ç±¤è‹¥ä¸ä¸€æ¨£ï¼Œå‰‡æ–°ç¯€é»å–ä»£èˆŠç¯€é»ã€‚
4. èˆŠç¯€é» èˆ‡ æ–°ç¯€é»æ¨™ç±¤è‹¥ä¸€æ¨£ï¼Œç¹¼çºŒæ¯”è¼ƒæ–°èˆŠç¯€é»çš„å±¬æ€§åŠå­ç¯€é»ã€‚( é¡å¤–ç”¨å‡½å¼è™•ç† )

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œdiff å‡½å¼éƒ½æ˜¯å›å‚³ **ä¸€å€‹å‡½å¼**ï¼Œåœ¨ä¸»ç¨‹å¼ **vNode.js** ä¸­ä½¿ç”¨ patch è®Šæ•¸æ¥ä½å›å‚³çš„å‡½å¼ï¼Œå†å‘¼å«å‚³å…¥èˆŠçš„å¯¦éš› Nodeï¼Œä¸¦è³¦å€¼å›å» ( `$rootEl` )ï¼Œé”åˆ°æ›´æ–° DOM ( ç•«é¢ ) çš„æ•ˆæœã€‚

```jsx showLineNumbers
const patch = diff(vApp, vNewApp) // diff å›å‚³çš„å‡½å¼ç”¨è®Šæ•¸ patch æ¥ä½
$rootEl = patch($rootEl) // æ›´æ–° DOM
```

<br />

**diff ä¸»è¦å‡½å¼**

```jsx showLineNumbers
// vOldNodeã€vNewNode æ˜¯ createElement() å›å‚³çµ¦ createVApp çš„ DOM ç‰©ä»¶
const diff = function (vOldNode, vNewNode) {
  // å‚³é€²ä¾†çš„æ–°ç¯€é»å¦‚æœæ˜¯ undefinedï¼Œä»£è¡¨è©²ç¯€é»æ˜¯è¦è¢«åˆªé™¤çš„ç¯€é»ï¼Œreturn undefined
  if (vNewNode === undefined) {
    return $node => {
      $node.remove()
      return undefined
    }
  }

  // å¦‚æœå‚³é€²ä¾†çš„ç¯€é»æ˜¯å­—ä¸²
  if (typeof vOldNode === 'string' || typeof vNewNode === 'string') {
    // å¦‚æœå­—ä¸²æœ‰æ”¹è®Šï¼Œå°±å›å‚³æ›è¼‰å‡½å¼ (èˆŠå­—ä¸² => æ–°å­—ä¸²)
    if (vOldNode !== vNewNode) {
      return $node => {
        const $newNode = render(vNewNode)
        return mount($newNode, $node)
      }
      // å¦‚æœå­—ä¸²æ²’æœ‰æ”¹è®Šï¼Œå°±å›å‚³ä¸€æ¨£çš„ç¯€é»
    } else {
      return $node => $node
    }
  }

  // å¦‚æœæ–°èˆŠç¯€é»æ¨™ç±¤ä¸ä¸€æ¨£ï¼Œå‰‡æ–°ç¯€é»å–ä»£èˆŠç¯€é»
  if (vOldNode.tagName !== vNewNode.tagName) {
    return $node => {
      const $newNode = render(vNewNode)
      return mount($newNode, $node)
    }
  }

  // æ–°èˆŠç¯€é»æ¨™ç±¤ä¸€æ¨£ï¼Œç¹¼çºŒæ¯”è¼ƒæ–°èˆŠç¯€é»çš„å±¬æ€§åŠå­ç¯€é»
  const patchAttrs = diffAttrs(vOldNode.attrs, vNewNode.attrs)
  const patchChildren = diffChildren(vOldNode.children, vNewNode.children)

  return $node => {
    patchAttrs($node)
    patchChildren($node)
    return $node
  }
}
```

<br />

**æ¯”è¼ƒæ–°èˆŠç¯€é»å±¬æ€§ `diffAttrs(oldAttrs, newAttrs)`**

æˆ‘å€‘éœ€è¦åœ¨æ¨™ç±¤ä¸Š **è¨­å®šå±¬æ€§** èˆ‡ **åˆªé™¤å±¬æ€§** å…©ç¨®åŠŸèƒ½ï¼Œé€™é‚ŠæŠŠéœ€è¦è®Šå‹•çš„å±¬æ€§ä½¿ç”¨ `patches` é™£åˆ—å„²å­˜å‡½å¼ã€‚

```jsx showLineNumbers
const diffAttrs = function (oldAttrs, newAttrs) {
  // å„²å­˜å±¬æ€§è®Šå‹•çš„ patch å‡½å¼
  const patches = []

  // æ–°å¢ "è¨­å®šæ–°å±¬æ€§çš„å‡½å¼" åˆ° patches é™£åˆ—
  for (const key in newAttrs) {
    patches.push($node => {
      $node.setAttribute(key, newAttrs[key])
      return $node
    })
  }

  // å¦‚æœ "æ²’æœ‰" èˆŠå±¬æ€§åœ¨æ–°å±¬æ€§ä¸Šï¼Œå°±æ–°å¢ "ç§»é™¤èˆŠå±¬æ€§å‡½å¼" åˆ° patches é™£åˆ—
  for (const key in oldAttrs) {
    if (!(key in newAttrs)) {
      patches.push($node => {
        $node.removeAttribute(key)
        return $node
      })
    }
  }

  // å›å‚³æ‰¹æ¬¡æ›´æ–°å‡½å¼ï¼Œé€™å€‹å‡½å¼æœƒåŸ·è¡Œåœ¨ patches é™£åˆ—è£¡æ¯å€‹å‡½å¼
  return $node => {
    patches.forEach(patch => {
      patch($node)
    })
  }
}
```

<br />

**æ¯”è¼ƒæ–°èˆŠç¯€é»çš„å­ç¯€é» `diffChildren(oldVChildren, newVChildren)`**

èˆ‡æ¯”è¼ƒæ–°èˆŠç¯€é»çš„å‡½å¼æ¦‚å¿µç›¸è¿‘ï¼Œä¸€æ¨£å°‡éœ€è¦æ›´æ–°çš„å­ç¯€é» push é€² childPatches åŠ additionalPatches é™£åˆ—ã€‚

```jsx
const diffChildren = function (oldVChildren, newVChildren) {
  // èˆŠç¯€é»åœ¨æ–°ç¯€é»ä¸Šæ˜¯å¦éœ€è¦æ›´æ–°æˆ–åˆªé™¤ (run diff)
  // å»ºç«‹ childPatches å‡½å¼é™£åˆ—ï¼Œè‹¥ newVChildren[i] ç‚º undefinedï¼Œå›å‚³ $node.remove() çš„å‡½å¼
  const childPatches = []
  oldVChildren.forEach((oldVChild, i) => {
    childPatches.push(diff(oldVChild, newVChildren[i]))
  })

  // æ’å…¥æ–°ç¯€é»æ™‚ï¼Œå»ºç«‹ additionalPatches å‡½å¼é™£åˆ—
  const additionalPatches = []
  newVChildren.slice(oldVChildren.length).forEach(additionalVChild => {
    additionalPatches.push($node => {
      $node.appendChild(render(additionalVChild))
      return $node
    })
  })

  // å›å‚³ patch å‡½å¼
  return $node => {
    // è‹¥åˆªé™¤å­ç¯€é»ï¼Œfor loop çš„ i å¯èƒ½æœƒè¶…é $node.childNodes çš„é•·åº¦ï¼Œæ‰€ä»¥å¾æœ€å¾Œä¸€å€‹ childNode é–‹å§‹è™•ç†ã€‚
    for (let i = childPatches.length - 1; i >= 0; i--) {
      const $child = $node.childNodes[i]
      const patch = childPatches[i]
      patch($child)
    }

    // æ’å…¥å­ç¯€é»
    additionalPatches.forEach(patch => {
      patch($node)
    })

    return $node
  }
}
```

<br />

#### diff å®Œæ•´ç¨‹å¼ç¢¼

```jsx
import mount from './mount.js'
import render from './render.js'

let diffCount = 0
let diffAttrsCount = 0
let diffChildrenCount = 0

// é€™é‚Šéƒ½æ˜¯å›å‚³ patch å‡½å¼
// vOldNodeã€vNewNode æ˜¯ createElement() å›å‚³çµ¦ createVApp çš„ DOM ç‰©ä»¶
const diff = function (vOldNode, vNewNode) {
  // å‚³é€²ä¾†çš„æ–°ç¯€é»å¦‚æœæ˜¯ undefinedï¼Œä»£è¡¨è©²ç¯€é»æ˜¯è¦è¢«åˆªé™¤çš„ç¯€é»ï¼Œreturn undefined
  if (vNewNode === undefined) {
    return $node => {
      $node.remove()
      return undefined
    }
  }

  // å¦‚æœå‚³é€²ä¾†çš„ç¯€é»æ˜¯å­—ä¸²
  if (typeof vOldNode === 'string' || typeof vNewNode === 'string') {
    // å¦‚æœå­—ä¸²æœ‰æ”¹è®Šï¼Œå°±å›å‚³æ›è¼‰å‡½å¼ (èˆŠå­—ä¸² => æ–°å­—ä¸²)
    if (vOldNode !== vNewNode) {
      return $node => {
        const $newNode = render(vNewNode)
        return mount($newNode, $node)
      }
      // å¦‚æœå­—ä¸²æ²’æœ‰æ”¹è®Šï¼Œå°±å›å‚³ä¸€æ¨£çš„ç¯€é»
    } else {
      return $node => $node
    }
  }

  // å¦‚æœæ–°èˆŠç¯€é»æ¨™ç±¤ä¸ä¸€æ¨£ï¼Œå‰‡æ–°ç¯€é»å–ä»£èˆŠç¯€é»
  if (vOldNode.tagName !== vNewNode.tagName) {
    return $node => {
      const $newNode = render(vNewNode)
      return mount($newNode, $node)
    }
  }

  // æ–°èˆŠç¯€é»æ¨™ç±¤ä¸€æ¨£ï¼Œç¹¼çºŒæ¯”è¼ƒæ–°èˆŠç¯€é»çš„å±¬æ€§åŠå­ç¯€é»
  const patchAttrs = diffAttrs(vOldNode.attrs, vNewNode.attrs)
  const patchChildren = diffChildren(vOldNode.children, vNewNode.children)

  return $node => {
    patchAttrs($node)
    patchChildren($node)
    return $node
  }
}

// å›å‚³æ‰¹æ¬¡æ›´æ–° attrs çš„å‡½å¼
const diffAttrs = function (oldAttrs, newAttrs) {
  // å„²å­˜å±¬æ€§è®Šå‹•çš„ patch å‡½å¼
  const patches = []

  // æ–°å¢ "è¨­å®šæ–°å±¬æ€§çš„å‡½å¼" åˆ° patches é™£åˆ—
  for (const key in newAttrs) {
    patches.push($node => {
      $node.setAttribute(key, newAttrs[key])
      return $node
    })
  }

  // å¦‚æœ "æ²’æœ‰" èˆŠå±¬æ€§åœ¨æ–°å±¬æ€§ä¸Šï¼Œå°±æ–°å¢ "ç§»é™¤èˆŠå±¬æ€§å‡½å¼" åˆ° patches é™£åˆ—
  for (const key in oldAttrs) {
    if (!(key in newAttrs)) {
      patches.push($node => {
        $node.removeAttribute(key)
        return $node
      })
    }
  }

  // å›å‚³æ‰¹æ¬¡æ›´æ–°å‡½å¼ï¼Œé€™å€‹å‡½å¼æœƒåŸ·è¡Œåœ¨ patches é™£åˆ—è£¡æ¯å€‹å‡½å¼
  return $node => {
    patches.forEach(patch => {
      patch($node)
    })
  }
}

// æ¯”è¼ƒæ–°èˆŠç¯€é»æ˜¯å¦éœ€è¦æ›´æ–°
const diffChildren = function (oldVChildren, newVChildren) {
  diffChildrenCount += 1
  // èˆŠç¯€é»åœ¨æ–°ç¯€é»ä¸Šæ˜¯å¦éœ€è¦æ›´æ–°æˆ–åˆªé™¤ (run diff)
  // å»ºç«‹ childPatches å‡½å¼é™£åˆ—ï¼Œè‹¥ newVChildren[i] ç‚º undefinedï¼Œå›å‚³ $node.remove() çš„å‡½å¼
  const childPatches = []
  oldVChildren.forEach((oldVChild, i) => {
    childPatches.push(diff(oldVChild, newVChildren[i]))
  })

  // æ’å…¥æ–°ç¯€é»æ™‚ï¼Œå»ºç«‹ additionalPatches å‡½å¼é™£åˆ—
  const additionalPatches = []
  newVChildren.slice(oldVChildren.length).forEach(additionalVChild => {
    additionalPatches.push($node => {
      $node.appendChild(render(additionalVChild))
      return $node
    })
  })

  // å›å‚³ patch å‡½å¼
  return $node => {
    // è‹¥åˆªé™¤å­ç¯€é»ï¼Œfor loop çš„ i å¯èƒ½æœƒè¶…é $node.childNodes çš„é•·åº¦ï¼Œæ‰€ä»¥å¾æœ€å¾Œä¸€å€‹ childNode é–‹å§‹è™•ç†ã€‚
    for (let i = childPatches.length - 1; i >= 0; i--) {
      const $child = $node.childNodes[i]
      const patch = childPatches[i]
      patch($child)
    }

    // æ’å…¥å­ç¯€é»
    additionalPatches.forEach(patch => {
      patch($node)
    })

    return $node
  }
}

export default diff
```

<br />

[GitHub å®Œæ•´ç¨‹å¼ç¢¼](https://github.com/tingminitime/vDOM_practice)

[Virtual DOM - Demo Page](https://tingminitime.github.io/vDOM_practice/)

<br />

## Reference

---

- [Virtual DOM | ç‚ºäº†ç­è§£åŸç†ï¼Œé‚£å°±ä¾†å¯¦ä½œä¸€å€‹ç°¡æ˜“ Virtual DOM å§ï¼](https://medium.com/æ‰‹å¯«ç­†è¨˜/build-a-simple-virtual-dom-5cf12ccf379f)
